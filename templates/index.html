<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralSub | AI å­—å¹•å·¥ä½œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', // Indigo 500
                        primary_hover: '#4f46e5', // Indigo 600
                        dark_bg: '#0f172a', // Slate 900
                        panel_bg: '#1e293b', // Slate 800
                        accent: '#10b981', // Emerald 500
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* åŠ¨ç”» */
        @keyframes pulse-border {
            0% { border-color: rgba(99, 102, 241, 0.4); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); }
            70% { border-color: rgba(99, 102, 241, 0); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { border-color: rgba(99, 102, 241, 0.4); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .anim-pulse-border {
            animation: pulse-border 2s infinite;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="bg-dark_bg text-slate-200 min-h-screen font-sans selection:bg-primary selection:text-white overflow-x-hidden">

    <nav class="border-b border-slate-800 bg-dark_bg/90 backdrop-blur-md fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-dna text-primary text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight text-white">Neural<span class="text-primary">Sub</span></span>
                    <span class="text-[10px] uppercase tracking-wider bg-primary/20 text-primary px-2 py-0.5 rounded-full border border-primary/20 font-bold">Pro</span>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-xs text-slate-400 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        ç³»ç»Ÿåœ¨çº¿
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-7 space-y-6">
            
            <div class="glass-panel rounded-2xl p-1 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10">
                <div class="border-2 border-dashed border-slate-700 hover:border-primary rounded-xl bg-slate-900/50 p-8 text-center cursor-pointer transition-colors group relative" id="dropZone">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept=".mp4,.mp3,.wav,.mkv,.flac,.m4a">
                    
                    <div id="uploadPrompt" class="space-y-4 pointer-events-none">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform duration-300 group-hover:bg-primary/20">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 group-hover:text-primary transition-colors"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ åª’ä½“æ–‡ä»¶</h3>
                            <p class="text-slate-500 text-sm mt-1">æ”¯æŒ MP4, MKV, MP3, WAV (æœ€å¤§ 500MB)</p>
                        </div>
                    </div>

                    <div id="filePreview" class="hidden flex items-center justify-between bg-slate-800 p-4 rounded-lg border border-slate-600 relative z-10">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded bg-primary/20 flex items-center justify-center text-primary">
                                <i class="fa-solid fa-file-video"></i>
                            </div>
                            <div class="text-left">
                                <p class="text-sm font-medium text-white truncate max-w-[200px]" id="fileName">video.mp4</p>
                                <p class="text-xs text-slate-400" id="fileSize">0 MB</p>
                            </div>
                        </div>
                        <button id="removeFileBtn" class="text-slate-400 hover:text-red-400 transition p-2 z-30">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 space-y-6">
                <div class="flex items-center gap-2 pb-4 border-b border-slate-700">
                    <i class="fa-solid fa-sliders text-primary"></i>
                    <h3 class="font-semibold text-white">æ¨¡å‹é…ç½®</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">å¬å†™æ¨¡å‹ (Whisper)</label>
                        <select id="sourceLang" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition text-white">
                            <option value="auto">âœ¨ è‡ªåŠ¨æ£€æµ‹è¯­è¨€</option>
                            <option value="en">ğŸ‡ºğŸ‡¸ è‹±è¯­ (English)</option>
                            <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Chinese)</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥è¯­ (Japanese)</option>
                            <option value="ko">ğŸ‡°ğŸ‡· éŸ©è¯­ (Korean)</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">ç¿»è¯‘æ¨¡å‹ (NLLB-200)</label>
                        <select id="targetLang" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition text-white">
                            <option value="zh-cn">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
                            <option value="en">ğŸ‡ºğŸ‡¸ è‹±è¯­</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥è¯­</option>
                            <option value="ko">ğŸ‡°ğŸ‡· éŸ©è¯­</option>
                            <option value="fr">ğŸ‡«ğŸ‡· æ³•è¯­</option>
                            <option value="de">ğŸ‡©ğŸ‡ª å¾·è¯­</option>
                        </select>
                    </div>
                </div>

                <div class="bg-slate-900/60 rounded-xl p-4 border border-slate-800 flex items-center justify-between group hover:border-primary/30 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500/20 to-primary/20 flex items-center justify-center border border-white/5">
                            <i class="fa-solid fa-brain text-purple-400 group-hover:animate-pulse"></i>
                        </div>
                        <div>
                            <div class="font-bold text-sm text-slate-200">Agentic Reflection (AI åæ€æ¨¡å¼)</div>
                            <div class="text-xs text-slate-500 mt-0.5">ä½¿ç”¨ LLM æ£€æŸ¥ç¿»è¯‘è¯­ç—…å¹¶è‡ªåŠ¨æ¶¦è‰² (è€—æ—¶å¢åŠ  30%)</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="useReflection" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>

                <button id="startBtn" disabled class="w-full group relative overflow-hidden bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl transition-all duration-300">
                    <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-primary to-purple-600 opacity-0 group-hover:opacity-100 group-enabled:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative flex items-center justify-center gap-2">
                        <span id="btnText">å¼€å§‹æ™ºèƒ½å¤„ç†</span>
                        <i id="btnIcon" class="fa-solid fa-bolt"></i>
                    </div>
                </button>

                <div class="glass-panel rounded-2xl p-6 mt-4">
                    <h3 class="font-bold text-white">BLEU ç¿»è¯‘è´¨é‡è¯„ä¼°</h3>

                    <button id="btn-evaluate"
                         class="bg-primary mt-3 px-4 py-2 rounded-lg text-white font-bold hover:bg-primary/80">
                        è¯„ä¼°ç¿»è¯‘ï¼ˆBLEUï¼‰
                    </button>

                    <input type="file" id="ref-file" accept=".srt" />
                    <button id="btn-upload-ref">ä¸Šä¼ å‚è€ƒå­—å¹•</button>


                <div id="bleu-result" class="mt-3 text-accent font-bold text-lg"></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-6 flex flex-col">
            
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">å¤„ç†æµæ°´çº¿</h3>
                <div class="space-y-0 relative">
                    <div class="absolute left-[19px] top-4 bottom-4 w-0.5 bg-slate-800"></div>
                    
                    <div class="relative flex items-start gap-4 step-item" id="step1">
                        <div class="relative z-10 w-10 h-10 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center transition-all duration-300 icon-box">
                            <i class="fa-solid fa-file-audio text-slate-500 text-xs"></i>
                        </div>
                        <div class="pt-2">
                            <h4 class="text-sm font-medium text-slate-400 transition-colors title">éŸ³é¢‘æå–ä¸é¢„å¤„ç†</h4>
                            <p class="text-xs text-slate-600 mt-0.5">FFmpeg 16kHz é‡‡æ ·</p>
                        </div>
                    </div>

                    <div class="relative flex items-start gap-4 step-item mt-6" id="step2">
                        <div class="relative z-10 w-10 h-10 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center transition-all duration-300 icon-box">
                            <i class="fa-solid fa-wave-square text-slate-500 text-xs"></i>
                        </div>
                        <div class="pt-2">
                            <h4 class="text-sm font-medium text-slate-400 transition-colors title">è¯­éŸ³è¯†åˆ« (ASR)</h4>
                            <p class="text-xs text-slate-600 mt-0.5">Whisper Base Model</p>
                        </div>
                    </div>

                    <div class="relative flex items-start gap-4 step-item mt-6" id="step3">
                        <div class="relative z-10 w-10 h-10 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center transition-all duration-300 icon-box">
                            <i class="fa-solid fa-language text-slate-500 text-xs"></i>
                        </div>
                        <div class="pt-2">
                            <h4 class="text-sm font-medium text-slate-400 transition-colors title">ç¥ç»æœºå™¨ç¿»è¯‘ (NMT)</h4>
                            <p class="text-xs text-slate-600 mt-0.5">NLLB-200 Transformer</p>
                        </div>
                    </div>

                    <div class="relative flex items-start gap-4 step-item mt-6" id="step4">
                        <div class="relative z-10 w-10 h-10 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center transition-all duration-300 icon-box">
                            <i class="fa-solid fa-microchip text-slate-500 text-xs"></i>
                        </div>
                        <div class="pt-2">
                            <h4 class="text-sm font-medium text-slate-400 transition-colors title">åæ€ä¸ç”Ÿæˆ</h4>
                            <p class="text-xs text-slate-600 mt-0.5">LLM Review & Optimization</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl flex flex-col flex-1 min-h-[300px] overflow-hidden">
                <div class="bg-slate-900 px-4 py-2 border-b border-slate-800 flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs font-mono text-slate-400">
                        <i class="fa-solid fa-terminal"></i>
                        <span>sys_kernel.log</span>
                    </div>
                    <button onclick="clearLog()" class="text-xs text-slate-600 hover:text-slate-400">æ¸…é™¤</button>
                </div>
                <div class="flex-1 bg-black/40 p-4 font-mono text-xs overflow-y-auto font-light leading-relaxed" id="consoleOutput">
                    <div class="text-slate-500 mb-1">> System initialized.</div>
                    <div class="text-slate-500 mb-1">> Waiting for user input...</div>
                </div>
            </div>

            <div id="downloadArea" class="hidden glass-panel rounded-2xl p-6 border-l-4 border-l-accent bg-accent/5">
                <!-- è¿™é‡Œçš„åˆå§‹å†…å®¹ä¼šè¢«JSè¦†ç›– -->
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-white">ğŸ‰ å¤„ç†å®Œæˆ</h3>
                        <p class="text-xs text-slate-400 mt-1">è€—æ—¶: <span id="timeCost" class="text-accent">0.0</span>s</p>
                    </div>
                    <a id="downloadLink" href="#" class="bg-accent hover:bg-emerald-400 text-slate-900 font-bold py-2.5 px-6 rounded-lg transition flex items-center gap-2 shadow-lg shadow-accent/20">
                        <i class="fa-solid fa-download"></i> ä¸‹è½½å­—å¹•
                    </a>
                </div>
            </div>
        </div>
      </div>
    </main>

    <script>
        // çŠ¶æ€ç®¡ç†
        let currentFile = null;
        let isProcessing = false;
        let processStartTime = 0;

        // DOM å…ƒç´ 
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const filePreview = document.getElementById('filePreview');
        const startBtn = document.getElementById('startBtn');
        const consoleOutput = document.getElementById('consoleOutput');

        // å·¥å…·å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'mb-1 break-words animate-fade-in';
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            
            let colorClass = 'text-slate-300';
            let prefix = 'INFO';
            
            if (type === 'error') { colorClass = 'text-red-400'; prefix = 'ERR'; }
            else if (type === 'success') { colorClass = 'text-accent'; prefix = 'OK'; }
            else if (type === 'warn') { colorClass = 'text-yellow-400'; prefix = 'WARN'; }
            else if (type === 'system') { colorClass = 'text-primary'; prefix = 'SYS'; }

            div.innerHTML = `<span class="opacity-30 mr-2">[${time}]</span><span class="${colorClass} font-bold mr-2">[${prefix}]</span><span class="${type === 'error' ? 'text-red-300' : 'text-slate-300'}">${msg}</span>`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function clearLog() {
            consoleOutput.innerHTML = '<div class="text-slate-500 mb-1">> Log cleared.</div>';
        }

        // æ–‡ä»¶å¤„ç†é€»è¾‘
        function handleFile(file) {
            if (!file) return;
            
            // éªŒè¯å¤§å° (500MB)
            if (file.size > 500 * 1024 * 1024) {
                log("æ–‡ä»¶è¿‡å¤§ (Max 500MB)", 'error');
                return;
            }

            currentFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
            
            uploadPrompt.classList.add('hidden');
            filePreview.classList.remove('hidden');
            startBtn.disabled = false;
            startBtn.classList.remove('bg-slate-800');
            
            log(`æ–‡ä»¶å·²å°±ç»ª: ${file.name}`, 'system');
            document.getElementById('downloadArea').classList.add('hidden');
        }

        // äº‹ä»¶ç›‘å¬
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        document.getElementById('removeFileBtn').addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢è§¦å‘ fileInput
            currentFile = null;
            fileInput.value = '';
            uploadPrompt.classList.remove('hidden');
            filePreview.classList.add('hidden');
            startBtn.disabled = true;
            startBtn.classList.add('bg-slate-800');
            resetSteps();
        });

        // æ›´æ–°æ­¥éª¤æ¡çŠ¶æ€
        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            const iconBox = step.querySelector('.icon-box');
            const icon = step.querySelector('i');
            const title = step.querySelector('.title');

            // é‡ç½®
            iconBox.className = 'relative z-10 w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 icon-box';
            
            if (status === 'active') {
                iconBox.classList.add('border-primary', 'bg-slate-900', 'text-primary', 'anim-pulse-border');
                title.classList.add('text-primary');
                title.classList.remove('text-slate-400');
            } else if (status === 'completed') {
                iconBox.classList.add('border-accent', 'bg-accent', 'text-slate-900');
                title.classList.add('text-accent');
                title.classList.remove('text-slate-400', 'text-primary');
                icon.className = 'fa-solid fa-check';
            } else {
                iconBox.classList.add('border-slate-700', 'bg-slate-900', 'text-slate-500');
            }
        }

        function resetSteps() {
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                const step = document.getElementById(id);
                const iconBox = step.querySelector('.icon-box');
                const icon = step.querySelector('i');
                const title = step.querySelector('.title');
                
                iconBox.className = 'relative z-10 w-10 h-10 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center transition-all duration-300 icon-box text-slate-500';
                title.className = 'text-sm font-medium text-slate-400 transition-colors title';
                
                // æ¢å¤åŸå§‹å›¾æ ‡
                if(id === 'step1') icon.className = 'fa-solid fa-file-audio text-xs';
                if(id === 'step2') icon.className = 'fa-solid fa-wave-square text-xs';
                if(id === 'step3') icon.className = 'fa-solid fa-language text-xs';
                if(id === 'step4') icon.className = 'fa-solid fa-microchip text-xs';
            });
        }

        // æ ¸å¿ƒæµç¨‹
        startBtn.addEventListener('click', async () => {
            if (isProcessing || !currentFile) return;
            
            isProcessing = true;
            processStartTime = Date.now();
            startBtn.disabled = true;
            document.getElementById('btnText').textContent = "å¤„ç†ä¸­...";
            document.getElementById('btnIcon').className = "fa-solid fa-circle-notch fa-spin";
            
            resetSteps();
            document.getElementById('downloadArea').classList.add('hidden');

            try {
                // Step 1: Upload
                updateStep('step1', 'active');
                log("æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...", 'system');
                
                const formData = new FormData();
                formData.append('file', currentFile);
                
                const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                const uploadData = await uploadRes.json();
                
                if (!uploadData.success) throw new Error(uploadData.error);
                
                log(`ä¸Šä¼ æˆåŠŸ: ${uploadData.filename}`, 'success');
                updateStep('step1', 'completed');

                // Step 2: Transcribe
                updateStep('step2', 'active');
                log("åŠ è½½ Whisper æ¨¡å‹è¿›è¡Œè½¬å½•...", 'system');
                
                const transcribeRes = await fetch('/api/transcribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: uploadData.file_path,
                        language: document.getElementById('sourceLang').value
                    })
                });
                const transcribeData = await transcribeRes.json();
                
                if (!transcribeData.success) throw new Error(transcribeData.error);
                
                log(`è½¬å½•å®Œæˆ. è¯†åˆ«åˆ°è¯­è¨€: ${transcribeData.language}, ç‰‡æ®µæ•°: ${transcribeData.segments.length}`, 'success');
                updateStep('step2', 'completed');

                // Step 3 & 4: Translate (Integrates Reflection)
                updateStep('step3', 'active');
                if (document.getElementById('useReflection').checked) {
                    updateStep('step4', 'active'); // åŒæ—¶æ¿€æ´»åæ€æ­¥éª¤UI
                }
                
                log(`å¯åŠ¨ NLLB-200 ç¥ç»ç¿»è¯‘ (Target: ${document.getElementById('targetLang').value})...`, 'system');
                
                const translateRes = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segments: transcribeData.segments,
                        target_language: document.getElementById('targetLang').value,
                        source_language: transcribeData.language,
                        use_reflection: document.getElementById('useReflection').checked
                    })
                });
                const translateData = await translateRes.json();
                
                if (!translateData.success) throw new Error(translateData.error);
                
                log("ç¿»è¯‘ä¸AIåæ€ä¼˜åŒ–å®Œæˆ", 'success');
                updateStep('step3', 'completed');
                updateStep('step4', 'completed');

                // ---------------------------------------------------------
                // Step 5: ç”ŸæˆåŒè¯­å­—å¹• (Generate Dual Subtitles)
                // ---------------------------------------------------------
                log("æ­£åœ¨ç”ŸæˆåŒè¯­å­—å¹•æ–‡ä»¶...", 'system');

                // 1. ç”ŸæˆåŸæ–‡æœªç¿»è¯‘å­—å¹• (Original)
                const genOriginalRes = await fetch('/api/generate-subtitle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segments: transcribeData.segments, // åŸå§‹ç‰‡æ®µ
                        format: 'srt',
                        filename: currentFile.name,
                        suffix: 'original' // åç¼€: _original
                    })
                });
                const genOriginalData = await genOriginalRes.json();
                window.referenceSubtitlePath = genOriginalData.file_path;
                // 2. ç”Ÿæˆå·²ç¿»è¯‘å­—å¹• (Translated)
                const genTransRes = await fetch('/api/generate-subtitle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segments: translateData.segments, // ç¿»è¯‘åç‰‡æ®µ
                        format: 'srt',
                        filename: currentFile.name,
                        suffix: 'translated' // åç¼€: _translated
                    })
                });
                const genTransData = await genTransRes.json();
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾› BLEU è¯„ä¼°ä½¿ç”¨
                window.candidateSubtitlePath = genTransData.file_path;
                log("åŒè¯­å­—å¹•æ–‡ä»¶ç”Ÿæˆå®Œæˆ", 'success');
                // ---------------------------------------------------------
                // å®Œæˆä¸æ˜¾ç¤º (Finish)
                // ---------------------------------------------------------
                const duration = ((Date.now() - processStartTime) / 1000).toFixed(1);
                // document.getElementById('timeCost').textContent = duration; // è¢«è¦†ç›–äº†ï¼Œä¸éœ€è¦
                
                const downloadArea = document.getElementById('downloadArea');
                
                // åˆ›å»ºåŸæ–‡æŒ‰é’®
                const btnOrg = `
                    <a href="${genOriginalData.download_url}" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2.5 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-file-lines"></i> ä¸‹è½½åŸæ–‡
                    </a>`;
                
                // åˆ›å»ºè¯‘æ–‡æŒ‰é’®
                const btnTrans = `
                    <a href="${genTransData.download_url}" class="flex-1 bg-accent hover:bg-emerald-400 text-slate-900 font-bold py-2.5 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-lg shadow-accent/20">
                        <i class="fa-solid fa-language"></i> ä¸‹è½½è¯‘æ–‡
                    </a>`;

                // æ›¿æ¢ HTML ç»“æ„
                downloadArea.innerHTML = `
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-white">ğŸ‰ å¤„ç†å®Œæˆ</h3>
                                <p class="text-xs text-slate-400 mt-1">è€—æ—¶: <span class="text-accent">${duration}</span>s</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                             ${btnOrg}
                             ${btnTrans}
                        </div>
                    </div>
                `;
                
                downloadArea.classList.remove('hidden');
                log(`ğŸ‰ å…¨éƒ¨æµç¨‹ç»“æŸ! åŸæ–‡ä¸è¯‘æ–‡å·²ç”Ÿæˆ`, 'success');

            } catch (err) {
                log(`æµç¨‹ç»ˆæ­¢: ${err.message}`, 'error');
                alert(`å‘ç”Ÿé”™è¯¯: ${err.message}`);
            } finally {
                isProcessing = false;
                startBtn.disabled = false;
                document.getElementById('btnText').textContent = "å¼€å§‹æ™ºèƒ½å¤„ç†";
                document.getElementById('btnIcon').className = "fa-solid fa-bolt";
            }
        });

        // ---------------------------------------------------------
        // BLEU è¯„ä¼°æŒ‰é’®é€»è¾‘
        // ---------------------------------------------------------

    document.getElementById("btn-upload-ref").addEventListener("click", async () => {
    const fileInput = document.getElementById("ref-file");

    if (!fileInput.files.length) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ª reference.srt æ–‡ä»¶ï¼");
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    const res = await fetch("/api/upload-reference", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    if (data.success) {
        alert("å‚è€ƒå­—å¹•ä¸Šä¼ æˆåŠŸï¼");
    } else {
        alert("ä¸Šä¼ å¤±è´¥ï¼š" + data.error);
    }
});

    document.getElementById("btn-evaluate")?.addEventListener("click", async function () {

    const referencePath = "data/reference.srt";

    if (!window.lastGeneratedSubtitlePath) {
        alert("è¯·å…ˆç”Ÿæˆå­—å¹•æ–‡ä»¶å†è¯„ä¼° BLEUï¼");
        return;
    }

    const candidatePath = window.lastGeneratedSubtitlePath;

    log("å¼€å§‹ BLEU ç¿»è¯‘è´¨é‡è¯„ä¼°...", "system");

    const response = await fetch("/api/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            reference_path: referencePath,
            candidate_path: candidatePath
        })
    });

    const result = await response.json();

    if (!result.success) {
        log("BLEU è¯„ä¼°å¤±è´¥ï¼š" + result.error, "error");
        alert("BLEU è¯„ä¼°å¤±è´¥ï¼š" + result.error);
        return;
    }

    log("BLEU è¯„ä¼°å®Œæˆï¼å¾—åˆ†ï¼š" + result.bleu.score.toFixed(2), "success");

    // å±•ç¤º UIï¼ˆä½ å·²ç»åŠ å¥½äº† bleuAreaï¼‰
    document.getElementById("bleuArea").classList.remove("hidden");
    document.getElementById("bleu-result").innerText =
        "BLEU å¾—åˆ†: " + result.bleu.score.toFixed(2);
    document.getElementById("bleu-result").classList.remove("hidden");
    });

    </script>
</body>
</html>